<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PlantWiz – Shopwise Consumption Report</title>
  <style>
    :root{
      --bg:#ffffff; --text:#1f2430; --muted:#6b7280; --grid:#e5e7eb;
      --blue:#0ea5e9; --blue-2:#1d4ed8; --green:#e8f7eb; --amber:#fbbf24;
      --pm:#e0f2fe; --cm:#dbeafe; --pd:#fde7da; --npd:#e8f7eb;
      --bad:#ef4444; --good:#22c55e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Segoe UI, Roboto, Arial, sans-serif;background:var(--bg);color:var(--text)}
    .wrap{padding:16px;max-width:1400px;margin:0 auto}
    .titlebar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .titlebar h1{font-size:20px;margin:0}
    .meta{font-size:12px;color:var(--muted)}
    .legend{display:flex;gap:14px;align-items:center;margin:8px 0 14px}
    .dot{width:12px;height:12px;border-radius:50%}

    .table-wrap{overflow:auto;border:1px solid var(--grid);border-radius:8px}
    table{border-collapse:separate;border-spacing:0;min-width:1200px;width:100%}
    thead th{position:sticky;top:0;z-index:3;background:#eef6ff;color:#0f172a;border-bottom:1px solid var(--grid)}
    th,td{padding:8px 10px;border-right:1px solid var(--grid);border-bottom:1px solid var(--grid);text-align:right;white-space:nowrap}
    th:first-child, td:first-child{position:sticky;left:0;background:#f8fafc;z-index:2;text-align:left}
    th:nth-child(2), td:nth-child(2){position:sticky;left:140px;background:#f8fafc;z-index:2;text-align:left}
    colgroup col.type{width:140px}
    colgroup col.area{width:220px}

    .group-left{background:#eef2ff;color:#111827;font-weight:600;text-align:center;border-right:1px solid var(--grid)}
    .pm-avg{background:var(--pm)}
    .cm-avg{background:var(--cm)}
    .pd-avg{background:var(--pd)}
    .npd-avg{background:var(--npd)}
    .daily-head{background:#e5f0ff;border-left:2px solid var(--blue-2);border-right:2px solid var(--blue-2)}
    .shift{color:#0f172a;font-weight:600}
    .total{background:var(--amber);font-weight:700}
    .variance-head{background:#f1f5f9}
    .type-cell{font-weight:700;color:#111827}
    .area-cell{font-weight:600;color:#111827}
    tbody tr:nth-child(odd) td{background:#fcfcfd}

    .muted{color:var(--muted)}
    .v-bad{color:var(--bad);font-weight:700}
    .v-good{color:var(--good);font-weight:700}

    @media print{
      .wrap{padding:0}
      .titlebar{margin:0 0 6px}
      .legend{display:none}
      .table-wrap{border:none}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="titlebar">
      <h1>SHOPWISE CONSUMPTION</h1>
      <div class="meta">Range: <span data-bind="dateFrom">—</span> to <span data-bind="dateTo">—</span> · Generated: <span data-bind="generated">—</span></div>
    </div>

    <div class="legend" aria-hidden="true">
      <div class="dot" style="background:var(--pm)"></div><span>Previous Month Avg.</span>
      <div class="dot" style="background:var(--cm)"></div><span>Current Month Avg.</span>
      <div class="dot" style="background:var(--pd)"></div><span>PD Cur. Month Avg.</span>
      <div class="dot" style="background:var(--npd)"></div><span>NPD Cur. Month Avg.</span>
      <div class="dot" style="background:var(--amber)"></div><span>Daily Total</span>
    </div>

    <div class="table-wrap">
      <table role="table" aria-label="Shopwise Consumption" id="reportTable">
        <colgroup>
          <col class="type" />
          <col class="area" />
        </colgroup>
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
  (async () => {
    // ---------- config ----------
    const repoUser   = "chinmay13tailor";
    const repoName   = "TPEMT_REPORT";
    const repoBranch = "main"; // change if you use another branch

    // Allow manual override: ?data=https://.../data.json
    const params = new URLSearchParams(location.search);
    const manual = params.get("data");

    // Compute base folder of current page
    const basePath = location.pathname.endsWith('/')
      ? location.pathname
      : location.pathname.replace(/[^/]+$/, '');

    // Candidate URLs (in order). We include nested folder fallbacks.
    const candidates = manual ? [manual] : [
      `${basePath}data.json?v=${Date.now()}`,                              // same folder
      `${basePath}${repoName}/data.json?v=${Date.now()}`,                 // nested /<repo>/<repo>/data.json
      `/` + `${repoName}/data.json?v=${Date.now()}`,                      // absolute /<repo>/data.json
      `https://raw.githubusercontent.com/${repoUser}/${repoName}/${repoBranch}/data.json?v=${Date.now()}`, // raw
      `http://localhost:8000/data.json?v=${Date.now()}`,                  // local server (C:\OptixReports)
      `http://127.0.0.1:8000/data.json?v=${Date.now()}`
    ];

    async function fetchWithTimeout(url, ms = 4000) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), ms);
      try {
        const res = await fetch(url, { cache: "no-store", signal: ctrl.signal });
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        const txt = await res.text();
        try { return JSON.parse(txt); }
        catch(e){ throw new Error("Not JSON at " + url); }
      } finally {
        clearTimeout(t);
      }
    }

    let data, used;
    for (const url of candidates) {
      try {
        data = await fetchWithTimeout(url);
        used = url;
        break;
      } catch (e) {
        console.warn("Source failed:", url, e.message);
      }
    }
    if (!data) {
      alert("Could not load data.json from any source.\n" +
            "Make sure either:\n" +
            "  • data.json is committed next to index.html (or try ?data=<url>), OR\n" +
            "  • run a local server in C:\\OptixReports with: python -m http.server 8000");
      return;
    }
    console.log("Loaded data from:", used);

    // ---------- header meta ----------
    const fmtDate = iso => new Date(iso).toLocaleDateString("en-GB");
    document.querySelector('[data-bind="dateFrom"]').textContent = fmtDate(data.from);
    document.querySelector('[data-bind="dateTo"]').textContent   = fmtDate(data.to);
    document.querySelector('[data-bind="generated"]').textContent = new Date(data.generatedAt).toLocaleString();

    // ---------- table rendering ----------
    const dateKey = r => new Date(r.Date).toISOString().slice(0,10);
    const uniqueDates = Array.from(new Set((data.rows||[]).map(dateKey))).sort();
    const dates = uniqueDates.slice(-3); // show last 3 days (adjust if you want more)

    // Group by Type -> Jace -> day
    const groups = {};
    for (const r of (data.rows||[])) {
      const t = r.Type || "—";
      const j = r.Jace || "—";
      const d = dateKey(r);
      groups[t] = groups[t] || {};
      groups[t][j] = groups[t][j] || {};
      groups[t][j][d] = r;
    }

    // Build thead
    const thead = document.getElementById("thead");
    const tr1 = document.createElement("tr");
    const tr2 = document.createElement("tr");
    const thGroup = (txt, span, cls="") => { const th=document.createElement("th"); th.textContent=txt; th.colSpan=span; if(cls) th.className=cls; return th; };
    const th = (txt, cls="") => { const el=document.createElement("th"); el.textContent=txt; if(cls) el.className=cls; return el; };

    tr1.appendChild(thGroup("", 2, "group-left"));
    tr1.appendChild(thGroup("Averages", 4));
    for (const d of dates) {
      const dn = new Date(d);
      tr1.appendChild(thGroup(dn.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"2-digit"}), 4, "daily-head"));
    }
    tr1.appendChild(thGroup("PD Variance vs Curr. Month Avg.", 1, "variance-head"));

    tr2.appendChild(th("TYPE"));
    tr2.appendChild(th("AREA"));
    tr2.appendChild(th("Previous Month Avg.", "pm-avg"));
    tr2.appendChild(th("Current Month Avg.", "cm-avg"));
    tr2.appendChild(th("PD Cur. Month Avg.", "pd-avg"));
    tr2.appendChild(th("NPD Cur. Month Avg.", "npd-avg"));
    for (const _ of dates) {
      tr2.appendChild(th("C-shift","shift"));
      tr2.appendChild(th("A-shift","shift"));
      tr2.appendChild(th("B-shift","shift"));
      tr2.appendChild(th("Total","total"));
    }
    thead.appendChild(tr1);
    thead.appendChild(tr2);

    // Body
    const tbody = document.getElementById("tbody");
    const fmtNum = v => (v ?? v === 0) ? Number(v).toLocaleString("en-IN") : "";

    for (const type of Object.keys(groups)) {
      const jaces = Object.keys(groups[type]);
      let first = true;
      for (const j of jaces) {
        const tr = document.createElement("tr");

        if (first) {
          const tdType = document.createElement("td");
          tdType.className = "type-cell";
          tdType.rowSpan = jaces.length;
          tdType.innerHTML = type.replace(" ", "<br/>");
          tr.appendChild(tdType);
          first = false;
        }

        const tdArea = document.createElement("td");
        tdArea.className = "area-cell";
        tdArea.textContent = j;
        tr.appendChild(tdArea);

        // Averages placeholders (wire later when logic is ready)
        const mk = (cls) => { const td=document.createElement("td"); td.className = cls + " muted"; td.textContent = "—"; return td; };
        tr.appendChild(mk("pm-avg"));
        tr.appendChild(mk("cm-avg"));
        tr.appendChild(mk("pd-avg"));
        tr.appendChild(mk("npd-avg"));

        for (const d of dates) {
          const r = (groups[type][j]||{})[d] || {};
          const c = r["Shift_3_Consumption"]; // C
          const a = r["Shift_1_Consumption"]; // A
          const b = r["Shift_2_Consumption"]; // B
          const total = (c ?? 0) + (a ?? 0) + (b ?? 0);

          const tdC = document.createElement("td"); tdC.textContent = fmtNum(c); tr.appendChild(tdC);
          const tdA = document.createElement("td"); tdA.textContent = fmtNum(a); tr.appendChild(tdA);
          const tdB = document.createElement("td"); tdB.textContent = fmtNum(b); tr.appendChild(tdB);
          const tdT = document.createElement("td"); tdT.className = "total"; tdT.textContent = fmtNum(total); tr.appendChild(tdT);
        }

        const tdVar = document.createElement("td");
        tdVar.className = "muted"; tdVar.textContent = "—";
        tr.appendChild(tdVar);

        tbody.appendChild(tr);
      }
    }
  })().catch(err=>{
    console.error(err);
    alert("Failed to load data.json: " + err.message);
  });
  </script>
</body>
</html>
